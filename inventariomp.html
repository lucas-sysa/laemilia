<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stock por Rack y Box</title>

  <!-- ===============================
       LIBRERÍAS EXTERNAS UTILIZADAS
       =============================== -->
  <!-- Librería para leer archivos Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Librería Chart.js para generar gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Iconos FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- ===============================
       ESTILOS DE LA INTERFAZ (CSS)
       =============================== -->
  <style>
    :root {
      --primary-color: #04847c;
      --accent-color: #355fb4;
      --bg-light: #f3f4f7;
      --bg-white: #ffffff;
      --text-color: #333;
      --border-radius: 12px;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-light);
      margin: 0;
      padding-top: 70px; /* deja espacio para la barra superior */
      color: var(--text-color);
    }

    /* ---------------------------
       MENÚ SUPERIOR (NAVBAR)
       --------------------------- */
/* ---------------------------
   MENÚ SUPERIOR (NAVBAR) - CSS REVISADO
   --------------------------- */
.menu-bar {
  position: fixed;
  top: 0; left: 0; right: 0;
  background-color: var(--primary-color);
  display: flex;
  justify-content: space-between; /* Distribuye espacio entre logo, inputs y botones */
  align-items: center;
  padding: 10px 30px;
  z-index: 1000;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  gap: 20px; /* Espacio entre los grupos */
}

/* NUEVO: Contenedor para alinear los dos campos de entrada horizontalmente */
.menu-inputs {
    display: flex;
    align-items: center;
    gap: 15px; /* Espacio entre el input de archivo y el de búsqueda */
    flex-grow: 1; /* Permite que este contenedor use el espacio disponible */
    justify-content: flex-end; /* Alinea los inputs a la derecha del logo */
}

/* Modificamos los estilos de los inputs para que se adapten a la barra */
/* Sobreescribe las reglas de input[type="file"] y .search-container anteriores */
.menu-bar input[type="file"],
.menu-bar #searchInput {
    margin: 0; /* Elimina márgenes automáticos que rompen el flex */
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 6px;
    background: #fff;
    width: auto; /* Permite que el ancho se ajuste al contenido o al flex */
}

/* Estilo específico para el buscador (sin el contenedor .search-container) */
.menu-bar #searchInput {
    /* Mantén el estilo del icono de lupa si lo tenías: */
    background-image: url('https://cdn-icons-png.flaticon.com/512/54/54481.png');
    background-size: 16px;
    background-position: 10px center;
    background-repeat: no-repeat;
    padding-left: 36px;
    width: 250px;
}
    .logo {
      height: 60px;
    }

    /* Grupo de botones de acción (imprimir / etiquetas) */
    .button-group {
      display: flex;
      gap: 12px;
    }

    .button-group button {
      display: flex;
      align-items: center;
      gap: 8px;
      background-color: #04847c;
      color: #ffffff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(4, 132, 124, 0.4);
      transition: background-color 0.3s, transform 0.2s;
    }

    .button-group button:hover {
      background-color: #036c67;
      box-shadow: 0 4px 12px rgba(3, 108, 103, 0.5);
      transform: translateY(-1px);
    }

    /* ---------------------------
       CONTENEDOR PRINCIPAL
       --------------------------- */
    .container {
      background-color: var(--bg-white);
      max-width: 1100px;
      margin: 40px auto;
      padding: 35px;
      border-radius: var(--border-radius);
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    }

    h1, h2 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 20px;
    }

    /* Input para carga de archivo Excel */
    input[type="file"] {
      display: block;
      margin: 20px auto;
      padding: 10px 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fff;
    }

    /* Buscador */
    .search-container {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 15px;
    }

    .search-container input {
      padding: 8px 12px 8px 36px;
      border: 1px solid #ccc;
      border-radius: 8px;
      width: 300px;
      background-image: url('https://cdn-icons-png.flaticon.com/512/54/54481.png');
      background-size: 16px;
      background-position: 10px center;
      background-repeat: no-repeat;
    }

    /* Panel de estadísticas rápidas */
    #dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .dash-card {
      background: #eef1f8;
      border-left: 6px solid var(--primary-color);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      text-align: center;
      transition: transform 0.2s;
    }

    .dash-card:hover {
      transform: translateY(-1px);
    }

    .dash-card span {
      display: block;
      font-size: 1.6rem;
      font-weight: bold;
      color: var(--accent-color);
      margin-top: 6px;
    }

    /* Tabla de resultados */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 0.95rem;
    }

    th {
      background: var(--primary-color);
      color: white;
      padding: 10px;
      border: none;
      text-transform: uppercase;
      font-weight: 600;
    }

    td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }

    tr:nth-child(even) {
      background-color: #f9f9fb;
    }

    tr:hover {
      background-color: #eef2f9;
    }

    .mensaje {
      text-align: center;
      padding: 15px;
      font-style: italic;
      color: #999;
    }

    canvas {
      max-width: 100%;
      margin-top: 40px;
    }

    /* Oculta elementos innecesarios al imprimir */
    @media print {
      .menu-bar, input, .search-container, #dashboard, canvas {
        display: none;
      }
    }
/* Añadir dentro del bloque <style> existente */

/* Ajuste de grid para 5 tarjetas */
#dashboard {
  /* Permite hasta 5 columnas */
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
}

/* Estilo para el input de conteo */
.input-conteo {
  width: 70px;
  padding: 5px;
  border: 1px solid #ccc;
  border-radius: 4px;
  text-align: center;
  font-size: 0.95rem;
}

/* Estilos de color para la diferencia */
.variance-pos {
  color: #28a745; /* Verde para stock sobrante */
  font-weight: bold;
}
.variance-neg {
  color: #dc3545; /* Rojo para stock faltante */
  font-weight: bold;
}
.variance-zero {
  color: #333; /* Color normal si no hay diferencia */
}
  </style>
</head>

<body>
  <!-- ===============================
       CABECERA SUPERIOR / MENÚ
       =============================== -->
<div class="menu-bar">
    <img src="Logo.png" class="logo">

    <div class="button-group">
        <button onclick="imprimirTabla()">Imprimir</button>
        <button onclick="descargarInformeCSV()">Descargar Informe</button>
        <button onclick="window.location.href='inyecciones/etiqueta.html'">Etiquetas</button>
    </div>
</div>

  <!-- ===============================
       CUERPO PRINCIPAL DE LA PÁGINA
       =============================== -->
  <div class="container">
    <h1>Consulta de Stock por Rack y Box</h1>

    <!-- Carga de archivo Excel -->
    <input type="file" id="fileInput" accept=".xls,.xlsx" />

    <!-- Tarjetas de resumen -->
<div id="dashboard">
  <div class="dash-card"><strong>Códigos con Stock:</strong><span id="totalItems">0</span></div>
  <div class="dash-card"><strong>Stock Total (Teórico):</strong><span id="totalStock">0</span></div>
  <div class="dash-card"><strong>Racks Usados:</strong><span id="totalRacks">0</span></div>
  <div class="dash-card"><strong>Boxs Usados:</strong><span id="totalBoxes">0</span></div>
  <div class="dash-card variance-card"><strong>Diferencia Total:</strong><span id="totalVariance">0</span></div>
</div>

    <!-- Gráfico de barras dinámico -->
    <canvas id="stockChart" height="120"></canvas>
<canvas id="varianceChart" height="120" style="margin-bottom: 40px;"></canvas>

    <!-- Tabla principal -->
    <h2>Resultado de Stock por Rack y Box</h2>
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="Buscar código, descripción, rack o box..." oninput="buscarEnTabla()">
    </div>

<table id="resultTable">
  <thead>
    <tr>
      <th>Código</th>
      <th>Descripción</th>
      <th>Rack</th>
      <th>Box</th>
      <th>Stock Teórico</th> <th>Stock Contado</th> <th>Diferencia</th>     </tr>
  </thead>
  <tbody>
    <tr><td class="mensaje" colspan="7">Carga un archivo para ver los resultados</td></tr> </tbody>
</table>

  </div>  
<script>
// Variables globales
let datos = [];          // Datos leídos del archivo Excel
let datosFiltrados = []; // Datos con stock > 0, consolidados y ORDENADOS
let chart;               // Instancia del gráfico de Stock
let varianceChart;       // Instancia del nuevo gráfico de Variación

/* ==================================================
   LECTURA DEL ARCHIVO EXCEL Y CONVERSIÓN A JSON
   ================================================== */
document.getElementById('fileInput').addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (!file) return;

    mostrarMensaje('<i class="fas fa-spinner fa-spin"></i> Procesando archivo...');
    
    const reader = new FileReader();
    reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];

        datos = XLSX.utils.sheet_to_json(worksheet);
        calcularStock();
    };
    reader.readAsArrayBuffer(file);
});


/* ==================================================
   PROCESAMIENTO DE DATOS, CÁLCULO DE STOCK Y ORDENAMIENTO
   ================================================== */
function calcularStock() {
    if (!datos.length) {
        mostrarMensaje('El archivo cargado está vacío.');
        return;
    }

    const resultados = {};
    datosFiltrados = []; 
    
    // 1. CÁLCULO DE STOCK CONSOLIDADO
    datos.forEach(item => {
        const codigo = (item['Codigo'] || '').toString().trim().toUpperCase();
        const descripcion = (item['Descripción'] || '').toString().trim();
        const rack = (item['Rack'] || '').toString().trim().toUpperCase();
        const box = (item['Box'] || '').toString().trim().toUpperCase();
        const entrada = Math.abs(parseFloat(item['Entrada de Stock']) || 0);
        const salida = Math.abs(parseFloat(item['Salida de Stock']) || 0);
        
        if (!codigo || !rack || !box) return;

        const clave = `${codigo}|${rack}|${box}`;
        if (!resultados[clave]) {
            // Se inicializa con valores para el conteo
            resultados[clave] = { codigo, descripcion, rack, box, stock: 0, stockContado: undefined, diferencia: undefined };
        }

        resultados[clave].stock += entrada - salida;
    });

    // 2. FILTRADO Y ALMACENAMIENTO DE STOCK POSITIVO
    Object.values(resultados).forEach(item => {
        if (item.stock > 0) {
            datosFiltrados.push(item);
        }
    });

    // 3. ORDENAMIENTO POR RACK Y LUEGO POR BOX
    datosFiltrados.sort((a, b) => {
        if (a.rack < b.rack) return -1;
        if (a.rack > b.rack) return 1;
        if (a.box < b.box) return -1;
        if (a.box > b.box) return 1;
        return 0;
    });

    // 4. Muestra los resultados iniciales (Renderizado)
    if (datosFiltrados.length === 0) {
        mostrarMensaje('No se encontraron items con stock positivo.');
    } else {
        renderizarTabla(datosFiltrados);
        actualizarDashboard(datosFiltrados);
        actualizarGraficoFiltrado(datosFiltrados);
        actualizarGraficoVariacion(datosFiltrados); // Inicializa el gráfico de variación
    }
}

// Muestra mensaje cuando no hay datos
function mostrarMensaje(msg) {
    const tbody = document.querySelector('#resultTable tbody');
    tbody.innerHTML = `<tr><td class="mensaje" colspan="7">${msg}</td></tr>`; 
    document.getElementById('totalItems').textContent = 0;
    document.getElementById('totalStock').textContent = 0;
    document.getElementById('totalRacks').textContent = 0;
    document.getElementById('totalBoxes').textContent = 0;
    document.getElementById('totalVariance').textContent = 0; 
    
    if (chart) chart.destroy();
    if (varianceChart) varianceChart.destroy(); // Destruye el gráfico de variación
}

/* ==================================================
   FUNCIÓN DE RENDERIZADO DE LA TABLA
   ================================================== */
function renderizarTabla(dataSet) {
    const tbody = document.querySelector('#resultTable tbody');
    tbody.innerHTML = ''; 
    
    dataSet.forEach((item, index) => { 
        const tr = document.createElement('tr');
        const stockContado = item.stockContado !== undefined ? item.stockContado : '';
        const diferencia = item.diferencia !== undefined ? item.diferencia : '';
        const diferenciaClass = diferencia > 0 ? 'variance-pos' : (diferencia < 0 ? 'variance-neg' : 'variance-zero');

        tr.innerHTML = `
            <td>${item.codigo}</td>
            <td>${item.descripcion}</td>
            <td>${item.rack}</td>
            <td>${item.box}</td>
            <td>${item.stock}</td>
            <td>
                <input type="number" 
                       min="0" 
                       value="${stockContado}"
                       class="input-conteo" 
                       data-index="${index}" 
                       oninput="manejarConteo(${index}, this)">
            </td>
            <td id="dif-${index}" class="${diferenciaClass}">${diferencia}</td>
        `;
        tbody.appendChild(tr);
    });
}

/* ==================================================
   FUNCIÓN: MANEJAR CONTEO Y CALCULAR DIFERENCIA EN TIEMPO REAL
   ================================================== */
function manejarConteo(index, inputElement) {
    const conteo = parseInt(inputElement.value) || 0;
    const item = datosFiltrados.filter(d => d.rack + d.box === datosFiltrados[index].rack + datosFiltrados[index].box)[0]; // Encuentra el item correcto
    
    const diferencia = conteo - item.stock; 
    
    item.stockContado = conteo;
    item.diferencia = diferencia;

    const tdDiferencia = document.getElementById(`dif-${index}`);
    tdDiferencia.textContent = diferencia;
    tdDiferencia.className = diferencia > 0 ? 'variance-pos' : (diferencia < 0 ? 'variance-neg' : 'variance-zero');

    actualizarDashboard(datosFiltrados); 
    actualizarGraficoVariacion(datosFiltrados); // Actualiza el gráfico de variación
}

/* ==================================================
   FUNCIÓN DE BÚSQUEDA EN LA TABLA
   ================================================== */
function buscarEnTabla() {
    const filtro = document.getElementById('searchInput').value.toLowerCase();
    
    if (filtro === '') {
        renderizarTabla(datosFiltrados);
        actualizarDashboard(datosFiltrados);
        actualizarGraficoFiltrado(datosFiltrados);
        actualizarGraficoVariacion(datosFiltrados);
        return;
    }

    const nuevosFiltrados = datosFiltrados.filter(item => {
        const textoBusqueda = `${item.codigo} ${item.descripcion} ${item.rack} ${item.box}`.toLowerCase();
        return textoBusqueda.includes(filtro);
    });

    renderizarTabla(nuevosFiltrados);
    actualizarDashboard(nuevosFiltrados);
    actualizarGraficoFiltrado(nuevosFiltrados);
    actualizarGraficoVariacion(nuevosFiltrados);
}

/* ==================================================
   ACTUALIZA LAS TARJETAS DE ESTADÍSTICAS
   ================================================== */
function actualizarDashboard(filtrados) {
    const racks = new Set();
    const boxes = new Set();
    let totalStock = 0;
    let totalVariance = 0; 

    filtrados.forEach(item => {
        totalStock += item.stock;
        racks.add(item.rack);
        boxes.add(item.box);
        
        if (item.diferencia !== undefined) {
             totalVariance += item.diferencia;
        }
    });

    document.getElementById('totalItems').textContent = filtrados.length;
    document.getElementById('totalStock').textContent = totalStock;
    document.getElementById('totalRacks').textContent = racks.size;
    document.getElementById('totalBoxes').textContent = boxes.size;
    document.getElementById('totalVariance').textContent = totalVariance;
    
    const varianceSpan = document.getElementById('totalVariance');
    varianceSpan.className = totalVariance > 0 ? 'variance-pos' : (totalVariance < 0 ? 'variance-neg' : 'variance-zero');
}

/* ==================================================
   ACTUALIZA GRÁFICO DE STOCK (TEÓRICO)
   ================================================== */
function actualizarGraficoFiltrado(dataSet) {
    const dataOrdenadaPorStock = [...dataSet].sort((a, b) => b.stock - a.stock);

    const dataToShow = dataOrdenadaPorStock.slice(0, 20); 
    const etiquetas = dataToShow.map(d => d.codigo);
    const valores = dataToShow.map(d => d.stock);
    
    const ctx = document.getElementById('stockChart').getContext('2d');
    if (chart) chart.destroy(); 
    chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: etiquetas,
            datasets: [{
                label: 'Stock Teórico por Código (Top 20)',
                data: valores,
                backgroundColor: 'rgba(72, 116, 190, 0.7)',
                borderColor: 'rgba(72, 116, 190, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });
}

/* ==================================================
   NUEVA FUNCIÓN: GRÁFICO DE VARIACIÓN (DIFERENCIA)
   ================================================== */
function actualizarGraficoVariacion(dataSet) {
    // 1. Filtrar solo ítems que tienen una diferencia ingresada
    const conDiferencia = dataSet.filter(item => item.diferencia !== undefined && item.diferencia !== 0);

    // 2. Ordenar por el valor absoluto de la diferencia (los mayores errores primero)
    const dataOrdenada = [...conDiferencia].sort((a, b) => Math.abs(b.diferencia) - Math.abs(a.diferencia));
    
    const dataToShow = dataOrdenada.slice(0, 10); // Tomamos el Top 10

    const etiquetas = dataToShow.map(d => `${d.codigo} (${d.rack}-${d.box})`);
    const valores = dataToShow.map(d => d.diferencia);
    
    // Asigna color basado en si la diferencia es positiva o negativa
    const colores = valores.map(val => val > 0 ? '#28a745' : '#dc3545');

    const ctx = document.getElementById('varianceChart').getContext('2d');
    if (varianceChart) varianceChart.destroy(); 
    
    varianceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: etiquetas,
            datasets: [{
                label: 'Diferencia de Inventario (Contado - Teórico) - Top 10',
                data: valores,
                backgroundColor: colores,
                borderColor: colores,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: { 
                y: { beginAtZero: true },
                x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } }
            }
        }
    });
}


/* ==================================================
   FUNCIÓN DE DESCARGA DE INFORME (CSV) - FINAL
   ================================================== */
function descargarInformeCSV() {
    if (datosFiltrados.length === 0) {
        alert("No hay datos cargados para generar el informe.");
        return;
    }

    // Usamos el PUNTO Y COMA como separador de campos (columnas) para compatibilidad con Excel regional.
    const FIELD_SEPARATOR = ";"; 
    
    // Encabezados del CSV
    const headers = ["Codigo", "Descripcion", "Rack", "Box", "Stock Teórico", "Stock Contado", "Diferencia"];
    
    // Mapea los datos (ya ordenados por Rack y Box)
    const csvContent = datosFiltrados.map(item => {
        const stockContado = item.stockContado !== undefined ? item.stockContado : 0;
        const diferencia = item.diferencia !== undefined ? item.diferencia : (stockContado - item.stock);
        
        // Función auxiliar para formatear la cadena y asegurar la separación correcta
        const formatValue = (value) => {
            let str = String(value);
            
            // 1. Reemplazar comas decimales por puntos (si es necesario) o simplemente usar el valor
            // (En este caso, las cantidades deberían ser enteros, pero es buena práctica)
            // 2. Encerrar en comillas si el valor contiene el separador (;)
            if (str.includes(FIELD_SEPARATOR) || str.includes('\n')) {
                // Escapar comillas internas y encerrar en comillas dobles
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        };

        return [
            formatValue(item.codigo), 
            formatValue(item.descripcion), 
            formatValue(item.rack), 
            formatValue(item.box), 
            formatValue(item.stock), // Valores numéricos
            formatValue(stockContado), 
            formatValue(diferencia)
        ].join(FIELD_SEPARATOR); // Usa el punto y coma como separador de columnas
    }).join("\n");

    // Une encabezados y contenido
    const finalCsv = headers.join(FIELD_SEPARATOR) + "\n" + csvContent;

    // Crea y descarga el archivo
    // Nota: Usamos 'text/csv;charset=utf-8' para asegurar la codificación de caracteres especiales
    const blob = new Blob([finalCsv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    
    const today = new Date().toISOString().slice(0, 10); 
    link.setAttribute('download', `Inventario_Reporte_Ordenado_${today}.csv`);
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}
/* ==================================================
   FUNCIÓN DE IMPRESIÓN
   ================================================== */
function imprimirTabla() {
    window.print();
}
  </script>
</body>
</html>



